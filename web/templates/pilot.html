{% extends "base.html" %}

{% block title %}Pilot {{ pilot.nickname }}{% endblock %}

{% block content %}
<section class="pilot-summary-section">
  <div class="pilot-summary-card">
    <h2>Pilot: {{ pilot.nickname }}</h2>
    <div class="pilot-stat-grid">
      <div class="pilot-stat-item">
        <span class="pilot-stat-label">Points</span>
        <span class="pilot-stat-value">{{ pilot.points }}</span>
      </div>
      <div class="pilot-stat-item">
        <span class="pilot-stat-label">Fastest lap</span>
        <span class="pilot-stat-value">{{ pilot.fastest_lap }}</span>
      </div>
      <div class="pilot-stat-item">
        <span class="pilot-stat-label">Consecutives</span>
        <span class="pilot-stat-value">{{ pilot.consecutives_str }}</span>
      </div>
      <div class="pilot-stat-item">
        <span class="pilot-stat-label">Total Laps</span>
        <span class="pilot-stat-value">{{ pilot.total_laps }}</span>
      </div>
      <div class="pilot-stat-item">
        <span class="pilot-stat-label">Avg Lap Time</span>
        <span class="pilot-stat-value">{{ pilot.average_lap_time }}</span>
      </div>
      <div class="pilot-stat-item">
        <span class="pilot-stat-label">Total Races</span>
        <span class="pilot-stat-value">{{ pilot.total_starts }}</span>
      </div>
      <div class="pilot-stat-item">
        <span class="pilot-stat-label">Unfinished Races</span>
        <span class="pilot-stat-value">{{ pilot.unfinished_races }}</span>
      </div>
      <div class="pilot-stat-item">
        <span class="pilot-stat-label">Success Ratio</span>
        <span class="pilot-stat-value">{{ pilot.success_ratio }}%</span>
      </div>
      <div class="pilot-stat-item">
        <span class="pilot-stat-label">Next Heat</span>
        <span class="pilot-stat-value">{{ pilot.next_heat }}</span>
      </div>
    </div>
  </div>
</section>

<section class="pilot-chart-section">
  <div class="pilot-chart-container">
    <h2>Lap Times Over Time</h2>
    <canvas id="lapTimeChart"></canvas>
  </div>
</section>

<section class="pilot-laps-section">
  <div class="pilot-laps-container">
    <h2>Laps by Round</h2>
    {% for round_name, laps in laps_by_round.items() %}
      <h3>{{ round_name }}</h3>
      <table class="results-table">
        <thead>
          <tr>
            <th>Lap</th>
            <th>Time (s)</th>
          </tr>
        </thead>
        <tbody>
          {% for lap in laps %}
          <tr>
            <td>{{ lap.lap }}</td>
            <td>{{ lap.time }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endfor %}
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const lapData = {{ pilot_lap_times | tojson }};
  const labels = lapData.map((_, i) => `Lap ${i + 1}`);

  // Compute 10-lap running average
  function runningAverage(data, windowSize) {
    return data.map((_, i, arr) => {
      if (i < windowSize - 1) return null;  // Not enough data yet
      const slice = arr.slice(i - windowSize + 1, i + 1);
      const sum = slice.reduce((a, b) => a + b, 0);
      return (sum / windowSize).toFixed(2);
    });
  }

  const runningAvg = runningAverage(lapData, 10);

  new Chart(document.getElementById("lapTimeChart"), {
    type: 'line',
    data: {
      labels: labels,
      datasets: [
        {
          label: "Lap Time (s)",
          data: lapData,
          fill: false,
          borderColor: "blue",
          tension: 0.3,
          borderWidth: 2
        },
        {
          label: "10-Lap Running Avg",
          data: runningAvg,
          fill: false,
          borderColor: "orange",
          borderDash: [5, 5],
          tension: 0.3,
          borderWidth: 2
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'top'
        },
        title: {
          display: true,
          text: 'Lap Times with 10-Lap Running Average'
        }
      },
      scales: {
        x: {
          title: {
            display: true,
            text: "Lap Number"
          }
        },
        y: {
          title: {
            display: true,
            text: "Time (s)"
          },
          beginAtZero: false
        }
      }
    }
  });
</script>
{% endblock %}

